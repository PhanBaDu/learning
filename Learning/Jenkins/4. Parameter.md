# JENKINS CI/CD PARAMETER



![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/MAhdQ0TajTOiA0NZm82DS.png?ixlib=js-3.7.0 "image.png")

# 1. BẮT ĐẦU
![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/kTDYg7NI2m-0RQKOOVn4e.png?ixlib=js-3.7.0 "image.png")



![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/aB-AxhBtcSptS6iyrCkP6.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/dz9uiK56ZVMCStzXMK9SH.png?ixlib=js-3.7.0 "image.png")



![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/L_g2t9I9YHdV8dpmxQ1Kq.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/Leekntvdd-LxOSBad9ik4.png?ixlib=js-3.7.0 "image.png")



![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/BTymELYYhR-oFWwMmCSPz.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/25fC9lorKalTaB1d2Vl93.png?ixlib=js-3.7.0 "image.png")



![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/WPypmSaa74DCZ-PyM5Vaj.png?ixlib=js-3.7.0 "image.png")

=> Sau khi save:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/9N43wmM1SsSkQXh9M3FzV.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/9fTXsma6zr_dtajIHwGSH.png?ixlib=js-3.7.0 "image.png")

=> Sự khác biệt là làm thủ công:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/C2xG-dK_E2ArSRJw8nf1q.png?ixlib=js-3.7.0 "image.png")

- Tiếp theo cài plugins: Tải
![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/mh9RKaSKSyEm4INCh1Q_K.png?ixlib=js-3.7.0 "image.png")

- Tiếp theo: Đã được bổ sung nhiều dạng choice nè
![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/lvDZbIyacWmzMEobS0tAe.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/tbBxhsENYrGKaDVJlZhkR.png?ixlib=js-3.7.0 "image.png")

- Sau đó xóa đi 2 tùy chọn cũ: rồi thêm tùy chọn mới + save. 
![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/V3xdB-O9ZP_kR2AilVY70.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/ILJKbnncKnk1P-YyxyhSF.png?ixlib=js-3.7.0 "image.png")

=> Kết quả:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/zIWJKDuQbWCHtVBBhs9wX.png?ixlib=js-3.7.0 "image.png")

- Sau khi ra được như trên thì làm như ảnh sau:
![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/oeVlWaBsv6gEr3yQFhINh.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/RDyKt3USr_ggHMw773dxu.png?ixlib=js-3.7.0 "image.png")

=> Hãy quay lại và click Configure:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/OkC4KkgrcLW6dxtO0fMus.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/BCrzAR3KhWhseN4Xa9bq4.png?ixlib=js-3.7.0 "image.png")

=> Save lại.

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/qlb4SRn5Gbh3RTTIwDyUf.png?ixlib=js-3.7.0 "image.png")

=> ĐM loằn ngoằn k cần approve thủ công:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/P1xsyuvTO3RR00DHcP6aX.png?ixlib=js-3.7.0 "image.png")

=> Nói chung là như này là oke:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/uwVXKgeau_MyUayGIsXcD.png?ixlib=js-3.7.0 "image.png")

- Tiếp tục config: muti select
![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/VFD4Gq5bP8HZ0vStu5VDI.png?ixlib=js-3.7.0 "image.png")

=> Kết quả:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/vlTgD23332WPlKRqcTjiN.png?ixlib=js-3.7.0 "image.png")

- Thêm 1 paramater nữa, xỉu:
![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/hjPrM8m19oAuZf04Rxb2l.png?ixlib=js-3.7.0 "image.png")

=> Giờ sẽ viết ở đây

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/wuT37kYjUfZV7Bselfml6.png?ixlib=js-3.7.0 "image.png")

```
appUser = "shoeshop"
appName = "shoe-ShoppingCart"
appVersion = "0.0.1-SNAPSHOT"
appType = "jar"
processName = "${appName}-${appVersion}.${appType}"
folderDeploy = "/datas/${appUser}"
buildScript = "mvn clean install -DskipTests=true"
copyScript = "sudo cp target/${processName} ${folderDeploy}"
permsScript = "sudo chown -R ${appUser}. ${folderDeploy}"
killScript = "sudo kill -9 \$(ps -ef| grep ${processName} | grep -v grep | awk '{print \$2}')"
runScript = "sudo su ${appUser} -c 'cd ${folderDeploy}; java -jar ${processName} > nohup.out 2>&1 &'"

def getProcessId(processName) {
    def processId = sh(returnStdout:true, script: """ ps -ef| grep ${processName} | grep -v grep | awk \'{print \$2}\' """, label: "get processId")
}

def startProcess() {
    stage("start") {
        sh(script: """ ${buildScript} """, label: "build with maven")
        sleep 5
        def processId = getProcessId("${processName}")
        if ("${processId}" == "")
            error("Cannot start process")
    }
    echo("${appName} with server " + params.server + " started")
}
```
![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/paq_-RfQrE6KJvI_0a7Yh.png?ixlib=js-3.7.0 "image.png")

=> Click build

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/fAaY3dlLi-sVNCH5r__J5.png?ixlib=js-3.7.0 "image.png")

=> Đã chạy

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/tCT5UHftI-hrA0Nf1KFOb.png?ixlib=js-3.7.0 "image.png")

- Test thôi h viết lại. + save 
```
appUser = "shoeshop"
appName = "shoe-ShoppingCart"
appVersion = "0.0.1-SNAPSHOT"
appType = "jar"
processName = "${appName}-${appVersion}.${appType}"
folderDeploy = "/datas/${appUser}"
buildScript = "mvn clean install -DskipTests=true"
copyScript = "sudo cp target/${processName} ${folderDeploy}"
permsScript = "sudo chown -R ${appUser}. ${folderDeploy}"
killScript = "sudo kill -9 \$(ps -ef| grep ${processName} | grep -v grep | awk '{print \$2}')"
runScript = "sudo su ${appUser} -c 'cd ${folderDeploy}; java -jar ${processName} > nohup.out 2>&1 &'"

def getProcessId(processName) {
    def processId = sh(returnStdout:true, script: """ ps -ef| grep ${processName} | grep -v grep | awk \'{print \$2}\' """, label: "get processId")
}

def startProcess() {
    stage("start") {
        sh(script: """ ${runScript} """, label: "build with maven")
        sleep 5
        def processId = getProcessId("${processName}")
        if ("${processId}" == "")
            error("Cannot start process")
    }
    echo("${appName} with server " + params.server + " started")
}

node(params.server) {
    currentBuild.displayName = params.action
    if (params.action == "start") {
        startProcess()
    }
}
```
=> Lại phát nựa

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/dLntDVrAr29mpfguF0ycC.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/4n9G_jcEC7FFR7d07v_h4.png?ixlib=js-3.7.0 "image.png")

=> Thành công:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/peJB134OWeQSlCeMvOoMF.png?ixlib=js-3.7.0 "image.png")

- Tiếp tục cấu hình stop:
```
appUser = "shoeshop"
appName = "shoe-ShoppingCart"
appVersion = "0.0.1-SNAPSHOT"
appType = "jar"
processName = "${appName}-${appVersion}.${appType}"
folderDeploy = "/datas/${appUser}"
buildScript = "mvn clean install -DskipTests=true"
copyScript = "sudo cp target/${processName} ${folderDeploy}"
permsScript = "sudo chown -R ${appUser}. ${folderDeploy}"
killScript = "sudo kill -9 \$(ps -ef| grep ${processName} | grep -v grep | awk '{print \$2}')"
runScript = "sudo su ${appUser} -c 'cd ${folderDeploy}; java -jar ${processName} > nohup.out 2>&1 &'"

def getProcessId(processName) {
    def processId = sh(returnStdout:true, script: """ ps -ef| grep ${processName} | grep -v grep | awk \'{print \$2}\' """, label: "get processId")
}

def startProcess() {
    stage("start") {
        sh(script: """ ${runScript} """, label: "build with maven")
        sleep 5
        def processId = getProcessId("${processName}")
        if ("${processId}" == "")
            error("Cannot start process")
    }
    echo("${appName} with server " + params.server + " started")
}

def stopProcess() {
    stage('stop') {
        def processId = getProcessId("${processName}")
        if ("${processId}" != "")
            sh(script: """ sudo kill -9 ${processId} """, label: "stop project")
        echo("${appName} with server " + params.server + " stoped")
    }
}

node(params.server) {
    currentBuild.displayName = params.action
    if (params.action == "start") {
        startProcess()
    }
    if (params.action == "stop") {
        stopProcess()
    }
}
```
=> Làm các bước tương tự

=> Kết quả:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/gDORybAdCRFqm08yk7H2o.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/5EPbpmjMwcP1ZJWv-Mbgm.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/WB5C-i1qThbuJOo9r-Ia8.png?ixlib=js-3.7.0 "image.png")

- Tiếp tục phát triển xỉu:
![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/PDSSuSCoHFJtFA6qmulie.png?ixlib=js-3.7.0 "image.png")

=> Thêm 1 dòng để lấy mã commit tag:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/etl8HkMeXBEm48JXAL0ZA.png?ixlib=js-3.7.0 "image.png")

=> Save lại đã: Là thấy.

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/fb5vGce59xx4dQ_fMVA6t.png?ixlib=js-3.7.0 "image.png")

*** Xem credentials ở đây:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/eOCxUlom5I8lzO12v3NFP.png?ixlib=js-3.7.0 "image.png")

```
appUser = "shoeshop"
appName = "shoe-ShoppingCart"
appVersion = "0.0.1-SNAPSHOT"
appType = "jar"
processName = "${appName}-${appVersion}.${appType}"
folderDeploy = "/datas/${appUser}"
buildScript = "mvn clean install -DskipTests=true"
copyScript = "sudo cp target/${processName} ${folderDeploy}"
permsScript = "sudo chown -R ${appUser}. ${folderDeploy}"
killScript = "sudo kill -9 \$(ps -ef| grep ${processName} | grep -v grep | awk '{print \$2}')"
runScript = "sudo su ${appUser} -c 'cd ${folderDeploy}; java -jar ${processName} > nohup.out 2>&1 &'"
gitLink = "http://git.badu.tech/shoeshop/shoeshop.git"

def getProcessId(processName) {
    def processId = sh(returnStdout:true, script: """ ps -ef| grep ${processName} | grep -v grep | awk \'{print \$2}\' """, label: "get processId")
}

def startProcess() {
    stage("start") {
        sh(script: """ ${runScript} """, label: "build with maven")
        sleep 5
        def processId = getProcessId("${processName}")
        if ("${processId}" == "")
            error("Cannot start process")
    }
    echo("${appName} with server " + params.server + " started")
}

def stopProcess() {
    stage('stop') {
        def processId = getProcessId("${processName}")
        if ("${processId}" != "")
            sh(script: """ sudo kill -9 ${processId} """, label: "stop project")
        echo("${appName} with server " + params.server + " stoped")
    }
}

def upcodeProcess() {
    stage("checkout") {
        if(params.hash == "") 
            error("require hashing for code update.")
        checkout([$class: 'GitSCM', branches: [[ name: params.hash]], userRemoteConfigs: [[ credentialsId: 'jenkins-gitlab-user-account', 
            url: gitLink ]]])
    }
}

node(params.server) {
    currentBuild.displayName = params.action
    if (params.action == "start") {
        startProcess()
    }
    if (params.action == "stop") {
        stopProcess()
    }
    if (params.action == "upcode") {
        // clone -> build -> deploy
        currentBuild.description = "server " + params.server + " with hash " + params.hash
        upcodeProcess()
    }
}
```
=> Lấy commit ở đây:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/uJkOj3GwKgjhlOsMQ7kzE.png?ixlib=js-3.7.0 "image.png")

=> Và:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/7KP09yDJc1Q2Pts71kFCW.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/HNtmkYCTPwhkLzaVOOK09.png?ixlib=js-3.7.0 "image.png")

=> Kết quả:



![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/sW3R3tq0_ZBxrmtgF29Dj.png?ixlib=js-3.7.0 "image.png")

- Tiếp tục cải tiến pipeline:
```
appUser = "shoeshop"
appName = "shoe-ShoppingCart"
appVersion = "0.0.1-SNAPSHOT"
appType = "jar"
processName = "${appName}-${appVersion}.${appType}"
folderDeploy = "/datas/${appUser}"
buildScript = "mvn clean install -DskipTests=true"
copyScript = "sudo cp target/${processName} ${folderDeploy}"
permsScript = "sudo chown -R ${appUser}. ${folderDeploy}"
killScript = "sudo kill -9 \$(ps -ef| grep ${processName} | grep -v grep | awk '{print \$2}')"
runScript = "sudo su ${appUser} -c 'cd ${folderDeploy}; java -jar ${processName} > nohup.out 2>&1 &'"
gitLink = "http://git.badu.tech/shoeshop/shoeshop.git"

def getProcessId(processName) {
    def processId = sh(returnStdout:true, script: """ ps -ef| grep ${processName} | grep -v grep | awk \'{print \$2}\' """, label: "get processId")
}

def startProcess() {
    stage("start") {
        sh(script: """ ${runScript} """, label: "build with maven")
        sleep 5
        def processId = getProcessId("${processName}")
        if ("${processId}" == "")
            error("Cannot start process")
    }
    echo("${appName} with server " + params.server + " started")
}

def stopProcess() {
    stage('stop') {
        def processId = getProcessId("${processName}")
        if ("${processId}" != "")
            sh(script: """ sudo kill -9 ${processId} """, label: "stop project")
        echo("${appName} with server " + params.server + " stoped")
    }
}

def upcodeProcess() {
    stage("checkout") {
        if(params.hash == "") 
            error("require hashing for code update.")
        checkout([$class: 'GitSCM', branches: [[ name: params.hash]], userRemoteConfigs: [[ credentialsId: 'jenkins-gitlab-user-account', 
            url: gitLink ]]])
    }
    stage("build") {
        sh(script: """ ${buildScript} """, label: "build with maven")
    }
    stage("config") {
        sh(script: """ ${copyScript} """, label: "copy .jar file into the deploy folder")
        sh(script: """ ${permsScript} """, label: "assign project permissions")
    }
}

node(params.server) {
    currentBuild.displayName = params.action
    if (params.action == "start") {
        startProcess()
    }
    if (params.action == "stop") {
        stopProcess()
    }
    if (params.action == "upcode") {
        // clone -> build -> deploy
        currentBuild.description = "server " + params.server + " with hash " + params.hash
        stopProcess()
        upcodeProcess()
        startProcess()
    }
}
```
=> Kết quả:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/UBDCC3b3OVt_Gzwfhacrs.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/kCICZIUDk7ClQ-DzLOUpF.png?ixlib=js-3.7.0 "image.png")



# 2. ĐẢM BẢO BACKUP
- Thêm:
![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/LqJXhCaeQwOHrfxXlKMpr.png?ixlib=js-3.7.0 "image.png")

- Thêm:


![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/eYM2I3yCqmskRycIF4LVi.png?ixlib=js-3.7.0 "image.png")

=> Vô dev làm như dưới:

```
shoeshop@dev-server:/root$ cd /datas/shoeshop/
shoeshop@dev-server:/datas/shoeshop$ ls
nohup.out  shoe-ShoppingCart-0.0.1-SNAPSHOT.jar
shoeshop@dev-server:/datas/shoeshop$ mkdir run
shoeshop@dev-server:/datas/shoeshop$ mkdir backups
shoeshop@dev-server:/datas/shoeshop$ ls
backups  nohup.out  run  shoe-ShoppingCart-0.0.1-SNAPSHOT.jar
shoeshop@dev-server:/datas/shoeshop$ rm -f nohup.out shoe-ShoppingCart-0.0.1-SNAPSHOT.jar
shoeshop@dev-server:/datas/shoeshop$
```
```
appUser = "shoeshop"
appName = "shoe-ShoppingCart"
appVersion = "0.0.1-SNAPSHOT"
appType = "jar"
processName = "${appName}-${appVersion}.${appType}"
folderDeploy = "/datas/${appUser}/run"
folderBackup = "/datas/${appUser}/backups"
folderMain = "/datas/${appUser}"
buildScript = "mvn clean install -DskipTests=true"
copyScript = "sudo cp target/${processName} ${folderDeploy}"
permsScript = "sudo chown -R ${appUser}. ${folderDeploy}"
killScript = "sudo kill -9 \$(ps -ef| grep ${processName} | grep -v grep | awk '{print \$2}')"
runScript = "sudo su ${appUser} -c 'cd ${folderDeploy}; java -jar ${processName} > nohup.out 2>&1 &'"
gitLink = "http://git.badu.tech/shoeshop/shoeshop.git"

def getProcessId(processName) {
    def processId = sh(returnStdout:true, script: """ ps -ef| grep ${processName} | grep -v grep | awk \'{print \$2}\' """, label: "get processId")
}

def startProcess() {
    stage("start") {
        sh(script: """ ${runScript} """, label: "build with maven")
        sleep 5
        def processId = getProcessId("${processName}")
        if ("${processId}" == "")
            error("Cannot start process")
    }
    echo("${appName} with server " + params.server + " started")
}

def stopProcess() {
    stage('stop') {
        def processId = getProcessId("${processName}")
        if ("${processId}" != "")
            sh(script: """ sudo kill -9 ${processId} """, label: "stop project")
        echo("${appName} with server " + params.server + " stoped")
    }
}

def upcodeProcess() {
    stage("checkout") {
        if(params.hash == "") 
            error("require hashing for code update.")
        checkout([$class: 'GitSCM', branches: [[ name: params.hash]], userRemoteConfigs: [[ credentialsId: 'jenkins-gitlab-user-account', 
            url: gitLink ]]])
    }
    stage("build") {
        sh(script: """ ${buildScript} """, label: "build with maven")
    }
    stage("config") {
        sh(script: """ ${copyScript} """, label: "copy .jar file into the deploy folder")
        sh(script: """ ${permsScript} """, label: "assign project permissions")
    }
}

node(params.server) {
    currentBuild.displayName = params.action
    if (params.action == "start") {
        startProcess()
    }
    if (params.action == "stop") {
        stopProcess()
    }
    if (params.action == "upcode") {
        // clone -> build -> deploy
        currentBuild.description = "server " + params.server + " with hash " + params.hash
        stopProcess()
        upcodeProcess()
        startProcess()
    }
}
```
=> Tiếp theo:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/PTumRJ2Rgs9svm0mYzAl3.png?ixlib=js-3.7.0 "image.png")

=> Kết quả sau khi thành công: thì dự án được lưu qua run

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/KZ4ESeEL1t29BP1AMWGsH.png?ixlib=js-3.7.0 "image.png")

```
shoeshop@dev-server:/root$ cd /datas/shoeshop/
shoeshop@dev-server:/datas/shoeshop$ ls
nohup.out  shoe-ShoppingCart-0.0.1-SNAPSHOT.jar
shoeshop@dev-server:/datas/shoeshop$ mkdir run
shoeshop@dev-server:/datas/shoeshop$ mkdir backups
shoeshop@dev-server:/datas/shoeshop$ ls
backups  nohup.out  run  shoe-ShoppingCart-0.0.1-SNAPSHOT.jar
shoeshop@dev-server:/datas/shoeshop$ rm -f nohup.out shoe-ShoppingCart-0.0.1-SNAPSHOT.jar
shoeshop@dev-server:/datas/shoeshop$ ls run/
nohup.out  shoe-ShoppingCart-0.0.1-SNAPSHOT.jar
shoeshop@dev-server:/datas/shoeshop$
```
- Tiếp:
![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/BlClRo9IvAmupuvGFFJ6R.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/-YqDGSbEFhr161GpwBoIn.png?ixlib=js-3.7.0 "image.png")

=> Save xong thì ra đây:



![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/KYWWnknGulbEChKOx_zJk.png?ixlib=js-3.7.0 "image.png")

=> Approve. làm liên tục

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/zgJ0auyJSsdtwSuvJ3Md7.png?ixlib=js-3.7.0 "image.png")

, lặp lui lặp tới 2 việc chọn rolback và approve

=> Đã xong:

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/dupzg-D60MN0mFMygqSK7.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/MHflDYtqt1i05OyiP0FoQ.png?ixlib=js-3.7.0 "image.png")

-> dev-server: Có zip và unzip

```
appUser = "shoeshop"
appName = "shoe-ShoppingCart"
appVersion = "0.0.1-SNAPSHOT"
appType = "jar"
processName = "${appName}-${appVersion}.${appType}"
folderDeploy = "/datas/${appUser}/run"
folderBackup = "/datas/${appUser}/backups"
folderMain = "/datas/${appUser}"
buildScript = "mvn clean install -DskipTests=true"
copyScript = "sudo cp target/${processName} ${folderDeploy}"
permsScript = "sudo chown -R ${appUser}. ${folderDeploy}"
killScript = "sudo kill -9 \$(ps -ef| grep ${processName} | grep -v grep | awk '{print \$2}')"
runScript = "sudo su ${appUser} -c 'cd ${folderDeploy}; java -jar ${processName} > nohup.out 2>&1 &'"
gitLink = "http://git.badu.tech/shoeshop/shoeshop.git"

def getProcessId(processName) {
    def processId = sh(returnStdout:true, script: """ ps -ef| grep ${processName} | grep -v grep | awk \'{print \$2}\' """, label: "get processId")
}

def startProcess() {
    stage("start") {
        sh(script: """ ${runScript} """, label: "build with maven")
        sleep 5
        def processId = getProcessId("${processName}")
        if ("${processId}" == "")
            error("Cannot start process")
    }
    echo("${appName} with server " + params.server + " started")
}

def stopProcess() {
    stage('stop') {
        def processId = getProcessId("${processName}")
        if ("${processId}" != "")
            sh(script: """ sudo kill -9 ${processId} """, label: "stop project")
        echo("${appName} with server " + params.server + " stoped")
    }
}

def upcodeProcess() {
    stage("checkout") {
        if(params.hash == "") 
            error("require hashing for code update.")
        checkout([$class: 'GitSCM', branches: [[ name: params.hash]], userRemoteConfigs: [[ credentialsId: 'jenkins-gitlab-user-account', 
            url: gitLink ]]])
    }
    stage("build") {
        sh(script: """ ${buildScript} """, label: "build with maven")
    }
    stage("config") {
        sh(script: """ ${copyScript} """, label: "copy .jar file into the deploy folder")
        sh(script: """ ${permsScript} """, label: "assign project permissions")
    }
}

def backupProcess() {
    stage('backup') {
        // shoe-ShoppingCart_03022024_1011.zip
        def timeStamp = new Date().format("ddMMyyyy_HHmm")
        def zipFileName = "${appName}_${timeStamp}" + ".zip"
        sh(script: """ sudo su ${appUser} -c "cd ${folderMain};zip -jr ${folderBackup}/${zipFileName} ${folderDeploy}"  """, label: "backup old version")
    }
}

def rollbackProcess() {
    stage('rollback') {
        sh(script: """ sudo su ${appUser} -c "cd ${folderDeploy};rm -rf *"  """, label: "delete the current version")
        sh(script: """ sudo su ${appUser} -c "cd ${folderBackup};unzip ${params.rollback_version} -d ${folderDeploy}" """, label: "rollback process")
    }
}

node(params.server) {
    currentBuild.displayName = params.action
    if (params.action == "start") {
        startProcess()
    }
    if (params.action == "stop") {
        stopProcess()
    }
    if (params.action == "upcode") {
        // clone -> build -> deploy
        currentBuild.description = "server " + params.server + " with hash " + params.hash
        backupProcess()
        stopProcess()
        upcodeProcess()
        startProcess()
    }
        if (params.action == "rollback") {
        stopProcess()
        rollbackProcess()
        startProcess()
    }
}
```
=> KQ

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/Ised8AHXfA8i4E2xwf6LF.png?ixlib=js-3.7.0 "image.png")

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/P0At9yXmS2WdPHoYuRhDc.png?ixlib=js-3.7.0 "image.png")

backup thành công.(đọc và tìm hiểu lại)

![image.png](https://eraser.imgix.net/workspaces/ms8VVCQIEJwr7L9pdqNL/CNuettIBX9RQxMRH9XPQjqaKVj02/wwn6pdr0HWXbpuPJE7l_v.png?ixlib=js-3.7.0 "image.png")

giờ có thể roolback toàn bộ pb trước đó, ví dụ code mới sai thì lấy lại code cũ chạy.

